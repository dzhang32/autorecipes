#' Create a meal plan
#'
#' @param recipebook a `RecipeBook-class` object.
#' @param days `character()` which days of the week to plan for.
#' @param meals `character()` which meals to plan for, out of "Lunch" and
#'   "Dinner".
#' @param method `character()` the method to use when creating a meal plan.
#' @param fav_only `logical()` whether to create a meal plan only using
#'   favourite recipes.
#'
#' @return `tibble::tibble()` containing a meal plan.
#' @export
#'
#' @examples
#' meal_plan <- create_meal_plan(recipebook_example)
#'
#' meal_plan
create_meal_plan <- function(recipebook,
    days = c("Mon", "Tues", "Wed", "Thurs", "Fri", "Sat", "Sun"),
    meals = c("Lunch", "Dinner"),
    method = c("auto", "random"),
    fav_only = FALSE) {
    if (!is(object, "RecipeBook")) {
        stop("object must be instance of RecipeBook-class")
    }
    validObject(recipebook)

    recipebook <- .filter_recipebook(recipebook, fav_only)

    method <- match.arg(method)
    calendar <- .create_calendar(days, meals)

    meal_plan_func <- .dispatch_meal_planner(method)

    chosen_recipe_indexes <- meal_plan_func(recipebook, nrow(calendar))

    meal_plan <- dplyr::bind_cols(calendar, recipebook[chosen_recipe_indexes, ])

    return(meal_plan)
}

#' @keywords internal
#' @noRd
.create_calendar <- function(days = c("Mon", "Tues", "Wed", "Thurs", "Fri", "Sat", "Sun"),
    meals = c("Lunch", "Dinner")) {
    valid_days <- c("Mon", "Tues", "Wed", "Thurs", "Fri", "Sat", "Sun")
    valid_meals <- c("Lunch", "Dinner")

    if (any(duplicated(days)) | any(duplicated(meals))) {
        warning("days or meals must not contain duplicated values, coercing")
        days <- unique(days)
        meals <- unique(meals)
    }

    if (any(!(days %in% valid_days))) {
        stop(
            "days must be one of: ",
            stringr::str_c(valid_days, collapse = ", ")
        )
    }

    if (any(!(meals %in% valid_meals))) {
        stop(
            "meals must be one of: ",
            stringr::str_c(valid_meals, collapse = ", ")
        )
    }

    calendar <- tidyr::expand_grid(
        day = factor(days, levels = valid_days),
        meal = factor(meals, levels = valid_meals)
    )

    return(calendar)
}

#' @keywords internal
#' @noRd
.dispatch_meal_planner <- function(method) {
    switch(method,
        "auto" = .create_meal_plan_random,
        "random" = .create_meal_plan_random
    )
}

#' @keywords internal
#' @noRd
.create_meal_plan_random <- function(recipebook, num_required) {
    replace <- if (nrow(recipebook) < num_required) TRUE else FALSE

    chosen_recipe_indexes <- sample(
        seq_len(nrow(recipebook)), num_required,
        replace = replace
    )

    return(chosen_recipe_indexes)
}

#' @keywords internal
#' @noRd
.filter_recipebook <- function(recipebook, fav_only) {
    if (fav_only) {
        if (!("fav" %in% colnames(recipebook))) {
            stop("To filter by favourites, recipebook must have the column 'fav'")
        }
        recipebook <- recipebook %>% dplyr::filter(fav)
    }

    return(recipebook)
}
